<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K8s Real-time Log Viewer</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        line-height: 1.6;
        background-color: #f4f4f9;
        color: #333;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background-color: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        font-size: 1.8em;
        color: #1a73e8;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
      }
      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        padding: 10px 18px;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      #connectBtn {
        background-color: #28a745;
        color: white;
      }
      #connectBtn:disabled {
        background-color: #94d3a2;
        cursor: not-allowed;
      }
      #disconnectBtn {
        background-color: #dc3545;
        color: white;
        margin-left: 10px;
      }
      #disconnectBtn:disabled {
        background-color: #f19ca7;
        cursor: not-allowed;
      }
      .log-container {
        margin-top: 25px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        height: 60vh;
        overflow-y: scroll;
        background-color: #f8f9fa;
        padding: 15px;
      }
      pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: "Menlo", "Monaco", "Consolas", "Courier New", monospace;
        font-size: 0.9em;
      }
      #status {
        font-weight: bold;
        padding: 8px;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 15px;
      }
      .status-disconnected {
        background-color: #ffebee;
        color: #c62828;
      }
      .status-connecting {
        background-color: #e3f2fd;
        color: #1565c0;
      }
      .status-connected {
        background-color: #e8f5e9;
        color: #2e7d32;
      }
      .log-entry {
        padding: 2px 0;
        border-bottom: 1px solid #eee;
      }

      .log-error {
        color: #d32f2f;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Kubernetes Real-time Log Viewer</h1>
      <div class="form-group">
        <label for="jwt">JWT Token:</label>
        <input type="password" id="jwt" placeholder="Enter your JWT token" />
      </div>
      <div class="form-group">
        <label for="subscriptionId">Subscription ID:</label>
        <input
          type="text"
          id="subscriptionId"
          placeholder="Enter the subscription ID"
        />
      </div>
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>

      <div class="form-group" style="margin-top: 20px">
        <label>Status:</label>
        <div id="status" class="status-disconnected">Disconnected</div>
      </div>

      <div class="log-container">
        <pre id="logs"></pre>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const jwtInput = document.getElementById("jwt");
      const subscriptionIdInput = document.getElementById("subscriptionId");
      const logsPre = document.getElementById("logs");
      const statusDiv = document.getElementById("status");
      let socket = null;

      function setStatus(state, message) {
        statusDiv.className = `status-${state}`;
        statusDiv.textContent = message || state;
      }

      function addLog(message, type = "info") {
        const logEntry = document.createElement("div");
        logEntry.className = `log-entry ${
          type === "error" ? "log-error" : ""
        }`;
        logEntry.textContent = message;
        logsPre.appendChild(logEntry);
        // Auto-scroll to the bottom
        logsPre.parentElement.scrollTop = logsPre.parentElement.scrollHeight;
      }

      connectBtn.addEventListener("click", () => {
        const token = jwtInput.value.trim();
        const subscriptionId = subscriptionIdInput.value.trim();

        if (!token || !subscriptionId) {
          alert("Please provide both a JWT token and a Subscription ID.");
          return;
        }

        // Initialize connection
        socket = io("http://localhost:3000/k8s-logs", {
          auth: {
            token,
            subscriptionId,
          },
        });

        connectBtn.disabled = true;
        jwtInput.disabled = true;
        subscriptionIdInput.disabled = true;
        setStatus("connecting", "Connecting...");

        socket.on("connect", () => {
          disconnectBtn.disabled = false;
          setStatus("connected", "Connected");
          addLog("Connection successful. Waiting for logs...");
        });

        socket.on("connect_error", (err) => {
          addLog(`Connection failed: ${err.message}`, "error");
          setStatus("disconnected", `Error: ${err.message}`);
          socket.disconnect();
          connectBtn.disabled = false;
          jwtInput.disabled = false;
          subscriptionIdInput.disabled = false;
        });

        socket.on("disconnect", () => {
          setStatus("disconnected", "Disconnected");
          addLog("Disconnected from server.");
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          jwtInput.disabled = false;
          subscriptionIdInput.disabled = false;
          socket = null;
        });

        socket.on("log-start", (message) => {
          addLog(`[SERVER] ${message}`);
        });

        socket.on("log-data", (data) => {
          addLog(data.trim());
        });

        socket.on("log-error", (errorMessage) => {
          addLog(`[SERVER ERROR] ${errorMessage}`, "error");
        });
      });

      disconnectBtn.addEventListener("click", () => {
        if (socket) {
          socket.disconnect();
        }
      });

      // Clear logs on page load
      logsPre.innerHTML = "";
    </script>
  </body>
</html>